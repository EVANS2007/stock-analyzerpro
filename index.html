<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StockAI Pro Â· æ™ºèƒ½è‚¡ç¥¨ç»ˆç«¯</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:#060608;color:#e2e2e8;font-family:'Helvetica Neue',Arial,sans-serif;overflow:hidden}
:root{
  --green:#00e87a;--red:#ff3d5a;--blue:#3d9eff;--gold:#f5a623;
  --bg:#060608;--bg1:#0d0d12;--bg2:#13131a;--bg3:#1a1a24;
  --border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.1);
  --text1:#f0f0f8;--text2:#9090a8;--text3:#55556a;
}
.layout{display:flex;height:100vh;width:100vw}
.sidebar{width:268px;min-width:268px;background:var(--bg1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.sidebar-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:9px}
.logo-icon{width:28px;height:28px;background:linear-gradient(135deg,var(--green),var(--blue));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.logo-text{font-size:13px;font-weight:800;color:var(--text1)}
.logo-sub{font-size:9px;color:var(--text3);font-family:monospace}
.search-wrap{padding:10px 12px;border-bottom:1px solid var(--border)}
.search-box{display:flex;gap:6px}
.search-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text1);font-size:12px;outline:none;padding:6px 10px;font-family:monospace;min-width:0;transition:border .15s}
.search-input:focus{border-color:rgba(0,232,122,0.35)}
.search-btn{background:var(--green);border:none;border-radius:6px;color:#000;cursor:pointer;font-size:11px;font-weight:700;padding:6px 10px;flex-shrink:0}
.market-tabs{display:flex;padding:8px 10px 4px;gap:2px;border-bottom:1px solid var(--border)}
.mkt-tab{flex:1;background:transparent;border:none;border-radius:5px;color:var(--text3);cursor:pointer;font-size:10px;font-family:monospace;padding:5px 2px;text-align:center;transition:all .15s}
.mkt-tab.active{background:var(--bg3);color:var(--green)}
.stock-list{flex:1;overflow-y:auto;padding:4px}
.stock-item{display:flex;align-items:center;padding:8px 10px;border-radius:7px;cursor:pointer;transition:background .12s;gap:6px;position:relative;border:1px solid transparent}
.stock-item:hover{background:var(--bg3)}
.stock-item.active{background:rgba(0,232,122,0.07);border-color:rgba(0,232,122,0.15)}
.si-info{flex:1;min-width:0}
.si-code{font-size:12px;font-weight:700;color:var(--text1);font-family:monospace;display:block}
.si-name{font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
.si-right{text-align:right;flex-shrink:0}
.si-price{font-size:12px;font-weight:700;font-family:monospace;color:var(--text1);display:block}
.si-pct{font-size:10px;font-family:monospace;display:block}
.up{color:var(--green)}.dn{color:var(--red)}
.star-btn{background:none;border:none;cursor:pointer;font-size:13px;opacity:.35;transition:opacity .15s;padding:1px;flex-shrink:0;line-height:1}
.star-btn:hover,.star-btn.on{opacity:1}
.alert-dot{width:5px;height:5px;border-radius:50%;background:var(--gold);position:absolute;top:7px;right:7px}
.topbar{background:var(--bg1);border-bottom:1px solid var(--border);padding:10px 18px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:10px;flex-wrap:wrap}
.hero-name{font-size:16px;font-weight:800;color:var(--text1)}
.hero-tag{font-size:10px;color:var(--text2);font-family:monospace;background:var(--bg3);border-radius:3px;padding:1px 6px}
.hero-sector{font-size:10px;color:var(--text3);background:var(--bg2);border-radius:3px;padding:1px 6px}
.hero-price{font-size:26px;font-weight:700;font-family:monospace;color:var(--text1)}
.hero-chg{font-size:12px;font-family:monospace;font-weight:600;border-radius:4px;padding:2px 8px}
.topbar-actions{display:flex;gap:6px;flex-shrink:0}
.abtn{background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;font-size:11px;padding:5px 11px;transition:all .15s;white-space:nowrap}
.abtn:hover{color:var(--text1)}
.abtn.star-on{color:var(--gold);border-color:rgba(245,166,35,.3);background:rgba(245,166,35,.06)}
.abtn.alert-on{color:var(--blue);border-color:rgba(61,158,255,.3);background:rgba(61,158,255,.06)}
.tab-bar{display:flex;padding:0 18px;background:var(--bg1);border-bottom:1px solid var(--border);flex-shrink:0}
.tab{background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text3);cursor:pointer;font-size:11px;font-family:monospace;padding:9px 12px;transition:all .15s}
.tab:hover{color:var(--text2)}
.tab.active{color:var(--green);border-bottom-color:var(--green)}
.content{flex:1;overflow-y:auto;padding:16px 18px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:9px;padding:14px}
.card-green{background:rgba(0,232,122,0.04);border:1px solid rgba(0,232,122,0.18);border-radius:9px;padding:14px}
.card-title{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;font-family:monospace;margin-bottom:12px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.mgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:8px;margin-bottom:14px}
.mc{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:10px 12px}
.mc.hl{background:rgba(0,232,122,0.05);border-color:rgba(0,232,122,0.2)}
.mc-l{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;font-family:monospace;margin-bottom:3px}
.mc-v{font-size:16px;font-weight:700;color:var(--text1);font-family:monospace}
.mc.hl .mc-v{color:var(--green)}
.mc-s{font-size:9px;color:var(--text3);margin-top:1px}
.chart-box{position:relative;height:260px}
.chart-box.tall{height:300px}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:12px;padding:22px;width:340px;max-width:92vw}
.modal-t{font-size:13px;font-weight:700;color:var(--text1);margin-bottom:2px}
.modal-s{font-size:11px;color:var(--text2);margin-bottom:18px}
.mlabel{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;font-family:monospace;margin-bottom:5px}
.minput{width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:6px;color:var(--text1);font-size:12px;outline:none;padding:7px 10px;font-family:monospace;margin-bottom:10px}
.minput:focus{border-color:rgba(61,158,255,.4)}
.mbtnrow{display:flex;gap:8px;margin-top:6px}
.mbtn{flex:1;border:none;border-radius:7px;cursor:pointer;font-size:12px;font-weight:600;padding:9px}
.mbtn.pri{background:var(--green);color:#000}
.mbtn.sec{background:var(--bg3);color:var(--text2);border:1px solid var(--border2)}
.alist{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;max-height:140px;overflow-y:auto}
.aitem{display:flex;align-items:center;justify-content:space-between;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:7px 10px;font-size:11px;font-family:monospace}
.adel{background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;padding:0 2px}
.adel:hover{color:var(--red)}
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--border2);border-radius:9px;padding:10px 14px;font-size:11px;font-family:monospace;color:var(--text1);z-index:200;transform:translateY(16px);opacity:0;transition:all .2s;pointer-events:none;max-width:280px}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:rgba(0,232,122,.4);color:var(--green)}
.toast.warn{border-color:rgba(245,166,35,.4);color:var(--gold)}
.dt{width:100%;border-collapse:collapse;font-size:11px;font-family:monospace}
.dt th{text-align:right;color:var(--text3);font-weight:500;padding-bottom:8px;border-bottom:1px solid var(--border);font-size:9px;text-transform:uppercase;letter-spacing:.06em}
.dt th:first-child{text-align:left}
.dt td{padding:7px 0;border-bottom:1px solid rgba(255,255,255,.025);text-align:right;color:var(--text2)}
.dt td:first-child{text-align:left;color:var(--text3)}
.chip{background:rgba(61,158,255,.1);border:1px solid rgba(61,158,255,.2);border-radius:4px;padding:2px 7px;font-size:10px;display:inline-flex;align-items:center;gap:4px;color:var(--text2);font-family:monospace;margin:2px}
.cdel{cursor:pointer;color:var(--text3);font-size:12px}
.cdel:hover{color:var(--red)}
.empty{text-align:center;padding:50px;color:var(--text3);font-size:12px;font-family:monospace;line-height:1.8}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
input::placeholder,select{font-family:inherit}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fade{animation:fadeUp .2s ease forwards}
</style>
</head>
<body>
<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo-icon">ğŸ“ˆ</div>
      <div><div class="logo-text">StockAI Pro</div><div class="logo-sub">INTELLIGENT TERMINAL</div></div>
    </div>
    <div class="search-wrap">
      <div class="search-box">
        <input id="sinput" class="search-input" placeholder="æœç´¢ä»£ç æˆ–åç§°  /  å¿«æ·é”®" oninput="filterStocks(this.value)" onkeydown="if(event.key==='Enter')doSearch()"/>
        <button class="search-btn" onclick="doSearch()">GO</button>
      </div>
    </div>
    <div class="market-tabs">
      <button class="mkt-tab active" onclick="switchMkt('watchlist',this)">â­è‡ªé€‰</button>
      <button class="mkt-tab" onclick="switchMkt('us',this)">ğŸ‡ºğŸ‡¸ç¾è‚¡</button>
      <button class="mkt-tab" onclick="switchMkt('cn',this)">ğŸ‡¨ğŸ‡³Aè‚¡</button>
      <button class="mkt-tab" onclick="switchMkt('hk',this)">ğŸ‡­ğŸ‡°æ¸¯è‚¡</button>
    </div>
    <div id="slist" class="stock-list"></div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <div>
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:3px">
          <span class="hero-name" id="hname">è‹¹æœ</span>
          <span class="hero-tag" id="hticker">AAPL</span>
          <span class="hero-sector" id="hsector">ç§‘æŠ€</span>
        </div>
        <div style="display:flex;align-items:baseline;gap:9px;flex-wrap:wrap">
          <span class="hero-price" id="hprice">189.50</span>
          <span class="hero-chg up" id="hchg">â–² 1.23 (+0.65%)</span>
        </div>
      </div>
      <div class="topbar-actions">
        <button class="abtn" id="bcmp" onclick="addToCompare()">âš–ï¸ å¯¹æ¯”</button>
        <button class="abtn" id="bstar" onclick="toggleWL()">â˜† è‡ªé€‰</button>
        <button class="abtn" id="balert" onclick="openAlert()">ğŸ”” æé†’</button>
      </div>
    </div>
    <div class="tab-bar">
      <button class="tab active" onclick="switchTab('ov',this)">æ¦‚è§ˆ</button>
      <button class="tab" onclick="switchTab('ch',this)">æŠ€æœ¯åˆ†æ</button>
      <button class="tab" onclick="switchTab('fi',this)">è´¢æŠ¥</button>
      <button class="tab" onclick="switchTab('cp',this)">å¤šè‚¡å¯¹æ¯”</button>
    </div>
    <div class="content fade" id="content"></div>
  </div>
</div>

<!-- Alert Modal -->
<div class="modal-bg hidden" id="amodal" onclick="if(event.target===this)closeAlert()">
  <div class="modal">
    <div class="modal-t" id="amod-t">ğŸ”” è®¾ç½®æé†’</div>
    <div class="modal-s" id="amod-s">ä»·æ ¼è§¦å‘æ—¶å‘é€é€šçŸ¥</div>
    <div class="alist" id="alist"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><div class="mlabel">è§¦å‘æ¡ä»¶</div>
        <select id="atype" class="minput" style="cursor:pointer">
          <option value="above">ä»·æ ¼é«˜äº</option>
          <option value="below">ä»·æ ¼ä½äº</option>
          <option value="up_pct">æ¶¨å¹…è¶…è¿‡ %</option>
          <option value="dn_pct">è·Œå¹…è¶…è¿‡ %</option>
        </select>
      </div>
      <div><div class="mlabel">ç›®æ ‡å€¼</div>
        <input id="aval" class="minput" type="number" placeholder="å¦‚ 200"/>
      </div>
    </div>
    <div class="mbtnrow">
      <button class="mbtn sec" onclick="closeAlert()">å–æ¶ˆ</button>
      <button class="mbtn pri" onclick="addAlert()">æ·»åŠ æé†’</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const DB={
  AAPL: {n:"è‹¹æœ",  m:"us",s:"ç§‘æŠ€",      p:189.5, pe:28.4,pb:43.2,cap:"2.94T",roe:"147%", eps:"6.67", b:"1.24",gm:"43.8%",nm:"25.3%",dr:"31%",dy:"0.5%",ra:"28.3%",cr:"0.99"},
  MSFT: {n:"å¾®è½¯",  m:"us",s:"ç§‘æŠ€",      p:415.3, pe:36.2,pb:13.1,cap:"3.08T",roe:"38.5%",eps:"11.46",b:"0.91",gm:"69.4%",nm:"35.6%",dr:"19%",dy:"0.7%",ra:"18.2%",cr:"1.35"},
  NVDA: {n:"è‹±ä¼Ÿè¾¾",m:"us",s:"åŠå¯¼ä½“",    p:875.4, pe:52.1,pb:28.7,cap:"2.16T",roe:"55.3%",eps:"16.84",b:"1.97",gm:"72.7%",nm:"48.9%",dr:"14%",dy:"0.03%",ra:"45.2%",cr:"4.17"},
  GOOGL:{n:"è°·æ­Œ",  m:"us",s:"ç§‘æŠ€",      p:175.8, pe:24.6,pb:6.8, cap:"2.17T",roe:"28.7%",eps:"7.14", b:"1.06",gm:"56.9%",nm:"23.5%",dr:"11%",dy:"â€”",   ra:"15.4%",cr:"2.11"},
  AMZN: {n:"äºšé©¬é€Š",m:"us",s:"ç”µå•†/äº‘",   p:198.7, pe:43.8,pb:8.2, cap:"2.08T",roe:"19.4%",eps:"4.53", b:"1.15",gm:"47.6%",nm:"5.3%", dr:"28%",dy:"â€”",   ra:"4.8%", cr:"1.07"},
  META: {n:"Meta",  m:"us",s:"ç¤¾äº¤åª’ä½“",  p:524.6, pe:27.3,pb:8.4, cap:"1.32T",roe:"31.6%",eps:"19.21",b:"1.28",gm:"81.8%",nm:"29.0%",dr:"14%",dy:"0.4%",ra:"19.3%",cr:"2.67"},
  TSLA: {n:"ç‰¹æ–¯æ‹‰",m:"us",s:"æ–°èƒ½æºè½¦",  p:248.3, pe:65.2,pb:12.8,cap:"791B", roe:"19.4%",eps:"3.81", b:"2.31",gm:"18.2%",nm:"15.5%",dr:"18%",dy:"â€”",   ra:"9.1%", cr:"1.73"},
  NFLX: {n:"å¥ˆé£",  m:"us",s:"æµåª’ä½“",    p:718.5, pe:45.2,pb:16.3,cap:"308B", roe:"35.8%",eps:"15.92",b:"1.33",gm:"43.1%",nm:"16.9%",dr:"35%",dy:"â€”",   ra:"10.4%",cr:"1.16"},
  BABA: {n:"é˜¿é‡Œ",  m:"us",s:"ç”µå•†/äº‘",   p:77.2,  pe:14.3,pb:1.8, cap:"198B", roe:"12.8%",eps:"5.41", b:"0.87",gm:"37.4%",nm:"7.6%", dr:"22%",dy:"â€”",   ra:"6.3%", cr:"1.42"},
  PDD:  {n:"æ‹¼å¤šå¤š",m:"us",s:"ç”µå•†",      p:142.4, pe:17.8,pb:5.2, cap:"197B", roe:"32.4%",eps:"8.00", b:"0.94",gm:"61.3%",nm:"25.8%",dr:"8%", dy:"â€”",   ra:"18.2%",cr:"2.34"},
  BIDU: {n:"ç™¾åº¦",  m:"us",s:"AI/æœç´¢",   p:89.4,  pe:13.2,pb:1.1, cap:"31B",  roe:"8.4%", eps:"6.77", b:"0.82",gm:"53.1%",nm:"12.4%",dr:"24%",dy:"â€”",   ra:"5.6%", cr:"2.76"},
  JD:   {n:"äº¬ä¸œ",  m:"us",s:"ç”µå•†",      p:28.6,  pe:22.1,pb:1.4, cap:"44B",  roe:"6.4%", eps:"1.29", b:"0.76",gm:"8.9%", nm:"2.1%", dr:"31%",dy:"â€”",   ra:"2.8%", cr:"1.08"},
  V:    {n:"VISA",  m:"us",s:"æ”¯ä»˜",      p:289.6, pe:31.2,pb:13.8,cap:"591B", roe:"44.2%",eps:"9.29", b:"0.93",gm:"80.4%",nm:"51.1%",dr:"31%",dy:"0.8%",ra:"19.6%",cr:"1.54"},
  JPM:  {n:"æ‘©æ ¹å¤§é€š",m:"us",s:"é“¶è¡Œ",    p:220.4, pe:12.4,pb:2.1, cap:"635B", roe:"16.8%",eps:"17.78",b:"1.12",gm:"â€”",    nm:"27.3%",dr:"â€”",  dy:"2.2%",ra:"1.4%", cr:"â€”"},
  ORCL: {n:"ç”²éª¨æ–‡",m:"us",s:"ä¼ä¸šè½¯ä»¶",  p:134.6, pe:34.1,pb:â€”,   cap:"369B", roe:"â€”",    eps:"3.95", b:"0.97",gm:"71.8%",nm:"21.4%",dr:"â€”",  dy:"1.3%",ra:"6.2%", cr:"0.84"},
  "600519":{n:"è´µå·èŒ…å°",m:"cn",s:"ç™½é…’",      p:1680,pe:29.5,pb:8.4, cap:"2.1T", roe:"31.2%",eps:"59.49",b:"0.62",gm:"91.9%",nm:"49.6%",dr:"8%", dy:"2.8%",ra:"26.1%",cr:"2.85"},
  "000858":{n:"äº”ç²®æ¶²",  m:"cn",s:"ç™½é…’",      p:138.4,pe:18.2,pb:4.8,cap:"540B", roe:"28.3%",eps:"7.60", b:"0.71",gm:"75.1%",nm:"34.8%",dr:"12%",dy:"3.5%",ra:"22.4%",cr:"3.12"},
  "601318":{n:"ä¸­å›½å¹³å®‰",m:"cn",s:"ä¿é™©",      p:45.2, pe:8.4, pb:1.1,cap:"815B", roe:"13.2%",eps:"5.38", b:"0.84",gm:"â€”",    nm:"10.4%",dr:"â€”",  dy:"5.2%",ra:"1.2%", cr:"â€”"},
  "600036":{n:"æ‹›å•†é“¶è¡Œ",m:"cn",s:"é“¶è¡Œ",      p:34.8, pe:5.8, pb:0.9,cap:"876B", roe:"15.6%",eps:"6.00", b:"0.78",gm:"â€”",    nm:"33.4%",dr:"â€”",  dy:"5.8%",ra:"1.3%", cr:"â€”"},
  "300750":{n:"å®å¾·æ—¶ä»£",m:"cn",s:"æ–°èƒ½æº",    p:185.6,pe:22.4,pb:4.2,cap:"812B", roe:"18.7%",eps:"8.28", b:"1.14",gm:"22.8%",nm:"11.2%",dr:"31%",dy:"1.2%",ra:"7.4%", cr:"1.38"},
  "002594":{n:"æ¯”äºšè¿ª",  m:"cn",s:"æ–°èƒ½æºè½¦",  p:238.6,pe:24.3,pb:4.1,cap:"693B", roe:"16.9%",eps:"9.82", b:"1.08",gm:"20.2%",nm:"5.1%", dr:"42%",dy:"0.8%",ra:"3.8%", cr:"0.98"},
  "601888":{n:"ä¸­å›½ä¸­å…",m:"cn",s:"é›¶å”®",      p:68.4, pe:21.6,pb:3.8,cap:"143B", roe:"17.8%",eps:"3.17", b:"0.88",gm:"32.4%",nm:"12.1%",dr:"18%",dy:"1.8%",ra:"8.4%", cr:"1.24"},
  "000001":{n:"å¹³å®‰é“¶è¡Œ",m:"cn",s:"é“¶è¡Œ",      p:11.2, pe:4.6, pb:0.6,cap:"218B", roe:"12.4%",eps:"2.43", b:"0.91",gm:"â€”",    nm:"28.6%",dr:"â€”",  dy:"4.9%",ra:"0.9%", cr:"â€”"},
  "0700": {n:"è…¾è®¯",     m:"hk",s:"ç§‘æŠ€/æ¸¸æˆ", p:389.8,pe:18.6,pb:3.4,cap:"3.73T",roe:"18.2%",eps:"20.96",b:"0.82",gm:"48.2%",nm:"27.4%",dr:"28%",dy:"0.9%",ra:"8.6%", cr:"1.68"},
  "9988": {n:"é˜¿é‡Œ(HK)", m:"hk",s:"ç”µå•†/äº‘",   p:78.4, pe:14.1,pb:1.7,cap:"1.54T",roe:"12.4%",eps:"5.56", b:"0.85",gm:"37.1%",nm:"7.4%", dr:"22%",dy:"â€”",   ra:"6.1%", cr:"1.44"},
  "3690": {n:"ç¾å›¢",     m:"hk",s:"æœ¬åœ°æœåŠ¡",  p:138.2,pe:28.4,pb:5.2,cap:"852B", roe:"18.4%",eps:"4.87", b:"0.96",gm:"24.6%",nm:"8.2%", dr:"24%",dy:"â€”",   ra:"6.8%", cr:"1.54"},
  "1299": {n:"å‹é‚¦ä¿é™©", m:"hk",s:"ä¿é™©",      p:52.8, pe:19.4,pb:2.1,cap:"598B", roe:"10.8%",eps:"2.72", b:"0.74",gm:"â€”",    nm:"14.2%",dr:"â€”",  dy:"2.8%",ra:"2.4%", cr:"â€”"},
  "0941": {n:"ä¸­å›½ç§»åŠ¨", m:"hk",s:"é€šä¿¡",      p:72.4, pe:10.2,pb:1.2,cap:"1.52T",roe:"11.4%",eps:"7.10", b:"0.58",gm:"28.4%",nm:"14.8%",dr:"14%",dy:"6.8%",ra:"7.2%", cr:"1.22"},
  "2318": {n:"å¹³å®‰(HK)", m:"hk",s:"ä¿é™©",      p:38.6, pe:7.8, pb:0.9,cap:"700B", roe:"12.8%",eps:"4.95", b:"0.81",gm:"â€”",    nm:"10.1%",dr:"â€”",  dy:"5.6%",ra:"1.1%", cr:"â€”"},
};

const QTR=[
  {q:"Q1'23",rv:1174,ni:241,eps:1.52},{q:"Q2'23",rv:1218,ni:198,eps:1.26},
  {q:"Q3'23",rv:1346,ni:307,eps:1.94},{q:"Q4'23",rv:1196,ni:224,eps:1.43},
  {q:"Q1'24",rv:1353,ni:289,eps:1.85},{q:"Q2'24",rv:1498,ni:341,eps:2.19},
];

let cur="AAPL", mkt="watchlist", tab="ov", chartType="price", cmpList=[], filterQ="";
let pd={}, ch={};
let WL=JSON.parse(localStorage.getItem("sai_wl")||'["AAPL","TSLA","NVDA","0700","600519"]');
let AL=JSON.parse(localStorage.getItem("sai_al")||"{}");
const saveWL=()=>localStorage.setItem("sai_wl",JSON.stringify(WL));
const saveAL=()=>localStorage.setItem("sai_al",JSON.stringify(AL));

function genPD(base,days=120){
  let p=base; const now=new Date();
  return Array.from({length:days+1},(_,i)=>{
    const d=new Date(now); d.setDate(d.getDate()-(days-i));
    p=Math.max(p+(Math.random()-.478)*p*.022,base*.45);
    const o=p+(Math.random()-.5)*p*.008,h=Math.max(p,o)*(1+Math.random()*.012),l=Math.min(p,o)*(1-Math.random()*.012);
    return{dt:d.toLocaleDateString("zh-CN",{month:"numeric",day:"numeric"}),c:+p.toFixed(2),o:+o.toFixed(2),h:+h.toFixed(2),l:+l.toFixed(2),v:Math.floor(Math.random()*5e7+5e6)};
  });
}
function addInd(data){
  return data.map((d,i)=>{
    const s20=data.slice(Math.max(0,i-19),i+1),s60=data.slice(Math.max(0,i-59),i+1);
    const ma20=+(s20.reduce((a,x)=>a+x.c,0)/s20.length).toFixed(2);
    const ma60=+(s60.reduce((a,x)=>a+x.c,0)/s60.length).toFixed(2);
    let rsi=null;
    if(i>=14){let g=0,ls=0;for(let j=i-13;j<=i;j++){const df=data[j].c-data[j-1].c;df>0?g+=df:ls-=df;}rsi=+(100-100/(1+g/(ls||.0001))).toFixed(1);}
    const k12=2/13,k26=2/27;let e12=data[0].c,e26=data[0].c;
    for(let j=1;j<=i;j++){e12=data[j].c*k12+e12*(1-k12);e26=data[j].c*k26+e26*(1-k26);}
    return{...d,ma20,ma60,rsi,macd:+(e12-e26).toFixed(3)};
  });
}
function getPD(t){if(!pd[t])pd[t]=addInd(genPD(DB[t].p));return pd[t];}
function quote(t){const d=getPD(t),l=d[d.length-1],p=d[d.length-2],c=l.c-p.c,pct=((c/p.c)*100).toFixed(2);return{price:l.c,chg:c,pct,up:c>=0};}

const CD={responsive:true,maintainAspectRatio:false,
  plugins:{legend:{display:false},tooltip:{backgroundColor:"#0d0d12",borderColor:"rgba(0,232,122,.3)",borderWidth:1,titleColor:"#9090a8",bodyColor:"#c8c8d8",titleFont:{family:"monospace",size:10},bodyFont:{family:"monospace",size:11},padding:10,mode:"index",intersect:false}},
  scales:{x:{grid:{color:"rgba(255,255,255,.03)"},ticks:{color:"#55556a",font:{family:"monospace",size:9}},border:{display:false}},
          y:{grid:{color:"rgba(255,255,255,.03)"},ticks:{color:"#55556a",font:{family:"monospace",size:9}},border:{display:false},position:"right"}}};
function dc(id){if(ch[id]){ch[id].destroy();delete ch[id];}}

function mcard(l,v,s,hl=false){return`<div class="mc${hl?' hl':''}"><div class="mc-l">${l}</div><div class="mc-v">${v}</div>${s?`<div class="mc-s">${s}</div>`:''}</div>`;}

// SIDEBAR
function renderSB(){
  const el=document.getElementById("slist"); el.innerHTML="";
  let items;
  if(mkt==="watchlist"){
    if(!WL.length){el.innerHTML='<div class="empty">è¿˜æ²¡æœ‰è‡ªé€‰è‚¡<br>ç‚¹è‚¡ç¥¨æ—çš„ â˜† æ·»åŠ </div>';return;}
    items=WL.map(t=>({t,...DB[t]})).filter(x=>x.n);
  } else {
    items=Object.entries(DB).filter(([t,s])=>s.m===mkt).map(([t,s])=>({t,...s}));
  }
  if(filterQ){const q=filterQ.toLowerCase();items=items.filter(x=>x.t.toLowerCase().includes(q)||x.n.includes(filterQ));}
  items.forEach(s=>{
    const q=quote(s.t),inWL=WL.includes(s.t),hasAl=AL[s.t]&&AL[s.t].length;
    const d=document.createElement("div");
    d.className="stock-item"+(s.t===cur?" active":"");
    d.innerHTML=`<div class="si-info"><span class="si-code">${s.t}</span><span class="si-name">${s.n} Â· ${s.s}</span></div>
      <div class="si-right"><span class="si-price">${q.price.toFixed(2)}</span><span class="si-pct ${q.up?'up':'dn'}">${q.up?'â–²':'â–¼'}${Math.abs(+q.pct)}%</span></div>
      <button class="star-btn ${inWL?'on':''}" onclick="event.stopPropagation();toggleWLfor('${s.t}')">${inWL?'â˜…':'â˜†'}</button>
      ${hasAl?'<div class="alert-dot"></div>':''}`;
    d.onclick=()=>load(s.t);
    el.appendChild(d);
  });
}

function switchMkt(m,btn){mkt=m;filterQ="";document.getElementById("sinput").value="";document.querySelectorAll(".mkt-tab").forEach(b=>b.classList.remove("active"));btn.classList.add("active");renderSB();}
function filterStocks(q){filterQ=q;renderSB();}
function doSearch(){
  const v=document.getElementById("sinput").value.trim();
  const k=DB[v.toUpperCase()]?v.toUpperCase():Object.keys(DB).find(t=>DB[t].n.includes(v))||"";
  if(k){load(k);document.getElementById("sinput").value="";}
  else showToast("æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨","warn");
}

// LOAD STOCK
function load(t){
  cur=t; const s=DB[t]; if(!s) return;
  const q=quote(t);
  document.getElementById("hname").textContent=s.n;
  document.getElementById("hticker").textContent=t;
  document.getElementById("hsector").textContent=s.s;
  document.getElementById("hprice").textContent=q.price.toFixed(2);
  const hc=document.getElementById("hchg");
  hc.textContent=`${q.up?'â–²':'â–¼'} ${Math.abs(q.chg).toFixed(2)} (${q.up?'+':''}${q.pct}%)`;
  hc.className=`hero-chg ${q.up?'up':'dn'}`;
  const inWL=WL.includes(t);
  document.getElementById("bstar").textContent=inWL?"â˜… å·²è‡ªé€‰":"â˜† è‡ªé€‰";
  document.getElementById("bstar").className=`abtn${inWL?" star-on":""}`;
  const hasAl=AL[t]&&AL[t].length;
  document.getElementById("balert").className=`abtn${hasAl?" alert-on":""}`;
  renderSB(); renderContent();
  checkAL(t,q.price);
}

// TABS
function switchTab(name,btn){
  tab=name;
  document.querySelectorAll(".tab-bar .tab").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  renderContent();
}
function renderContent(){
  const el=document.getElementById("content");
  el.className="content fade"; void el.offsetWidth;
  if(tab==="ov")renderOV();
  else if(tab==="ch")renderCH();
  else if(tab==="fi")renderFI();
  else if(tab==="cp")renderCP();
}

// OVERVIEW
function renderOV(){
  const s=DB[cur];
  document.getElementById("content").innerHTML=`
    <div class="mgrid">
      ${mcard("å¸‚å€¼",s.cap,"",true)}${mcard("å¸‚ç›ˆç‡ P/E",s.pe,"è¶Šä½è¶Šä¾¿å®œ")}
      ${mcard("å¸‚å‡€ç‡ P/B",s.pb,"")}${mcard("ROE",s.roe,"è¶Šé«˜è¶Šä¼˜è´¨")}
      ${mcard("EPS","$"+s.eps,"æ¯è‚¡æ”¶ç›Š")}${mcard("Beta",s.b,"æ³¢åŠ¨ç³»æ•°")}
      ${mcard("è‚¡æ¯ç‡",s.dy,"")}${mcard("èµ„äº§è´Ÿå€ºç‡",s.dr,"è¶Šä½è¶Šå®‰å…¨")}
    </div>
    <div class="grid2" style="margin-bottom:10px">
      <div class="card"><div class="card-title">è¥æ”¶ vs å‡€åˆ©æ¶¦ï¼ˆäº¿ï¼‰</div><div class="chart-box"><canvas id="cv-bar"></canvas></div></div>
      <div class="card"><div class="card-title">EPS æ¯è‚¡æ”¶ç›Šè¶‹åŠ¿</div><div class="chart-box"><canvas id="cv-eps"></canvas></div></div>
    </div>
    <div class="card"><div class="card-title">ä»·æ ¼èµ°åŠ¿ï¼ˆè¿‘60æ—¥ï¼‰</div><div class="chart-box"><canvas id="cv-price"></canvas></div></div>`;
  setTimeout(()=>{
    const disp=getPD(cur).slice(-60);
    dc("cv-bar");dc("cv-eps");dc("cv-price");
    ch["cv-bar"]=new Chart(document.getElementById("cv-bar"),{type:"bar",data:{labels:QTR.map(q=>q.q),datasets:[
      {label:"è¥æ”¶",data:QTR.map(q=>q.rv),backgroundColor:"rgba(61,158,255,.5)",borderRadius:3},
      {label:"å‡€åˆ©æ¶¦",data:QTR.map(q=>q.ni),backgroundColor:"rgba(0,232,122,.6)",borderRadius:3},
    ]},options:CD});
    ch["cv-eps"]=new Chart(document.getElementById("cv-eps"),{type:"line",data:{labels:QTR.map(q=>q.q),datasets:[
      {label:"EPS",data:QTR.map(q=>q.eps),borderColor:"#00e87a",backgroundColor:"rgba(0,232,122,.07)",borderWidth:2,pointBackgroundColor:"#00e87a",pointRadius:3,fill:true,tension:.4}
    ]},options:CD});
    ch["cv-price"]=new Chart(document.getElementById("cv-price"),{type:"line",data:{labels:disp.map(d=>d.dt),datasets:[
      {label:"æ”¶ç›˜ä»·",data:disp.map(d=>d.c),borderColor:"#00e87a",backgroundColor:"rgba(0,232,122,.06)",borderWidth:2,pointRadius:0,fill:true,tension:.3},
      {label:"MA20",data:disp.map(d=>d.ma20),borderColor:"#3d9eff",borderWidth:1.5,pointRadius:0,fill:false,borderDash:[4,3],tension:.3},
    ]},options:CD});
  },50);
}

// CHART
function renderCH(){
  document.getElementById("content").innerHTML=`
    <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px" id="ctabs">
      ${["price","rsi","macd","volume"].map((t,i)=>`<button class="tab${i===0?' active':''}" style="border-bottom-color:${i===0?'var(--green)':'transparent'}" onclick="swCH('${t}',this)">${{price:'ä»·æ ¼+å‡çº¿',rsi:'RSI',macd:'MACD',volume:'æˆäº¤é‡'}[t]}</button>`).join("")}
    </div>
    <div class="card" style="margin-bottom:10px"><div class="chart-box tall"><canvas id="cv-main"></canvas></div></div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px">
      ${mcard("52å‘¨æœ€é«˜",(quote(cur).price*1.28).toFixed(2),"")}
      ${mcard("52å‘¨æœ€ä½",(quote(cur).price*0.72).toFixed(2),"")}
      ${mcard("RSI(14)",getPD(cur).slice(-1)[0].rsi||"--","")}
      ${mcard("20æ—¥å‡é‡","42M","")}
    </div>
    <div style="display:flex;gap:12px;font-size:10px;font-family:monospace;color:var(--text3)">
      <span style="color:var(--green)">â— æ”¶ç›˜ä»·</span><span style="color:var(--blue)">â— MA20</span><span style="color:#ff9500">â— MA60</span>
    </div>`;
  setTimeout(()=>drawCH("price"),50);
}
function swCH(type,btn){
  document.querySelectorAll("#ctabs .tab").forEach(b=>{b.classList.remove("active");b.style.borderBottomColor="transparent";});
  btn.classList.add("active");btn.style.borderBottomColor="var(--green)";
  drawCH(type);
}
function drawCH(type){
  dc("cv-main"); const disp=getPD(cur).slice(-60),labels=disp.map(d=>d.dt); let cfg;
  if(type==="price"){cfg={type:"line",data:{labels,datasets:[
    {label:"æ”¶ç›˜ä»·",data:disp.map(d=>d.c),borderColor:"#00e87a",backgroundColor:"rgba(0,232,122,.06)",borderWidth:2,pointRadius:0,fill:true,tension:.3},
    {label:"MA20",data:disp.map(d=>d.ma20),borderColor:"#3d9eff",borderWidth:1.5,pointRadius:0,fill:false,borderDash:[4,3],tension:.3},
    {label:"MA60",data:disp.map(d=>d.ma60),borderColor:"#ff9500",borderWidth:1.5,pointRadius:0,fill:false,borderDash:[4,3],tension:.3},
  ]},options:CD};}
  else if(type==="rsi"){cfg={type:"line",data:{labels,datasets:[
    {label:"RSI",data:disp.map(d=>d.rsi),borderColor:"#a855f7",backgroundColor:"rgba(168,85,247,.08)",borderWidth:2,pointRadius:0,fill:true,tension:.3},
  ]},options:{...CD,scales:{...CD.scales,y:{...CD.scales.y,min:0,max:100}}}};}
  else if(type==="macd"){cfg={type:"bar",data:{labels,datasets:[
    {label:"MACD",data:disp.map(d=>d.macd),backgroundColor:disp.map(d=>d.macd>=0?"rgba(0,232,122,.6)":"rgba(255,61,90,.6)"),borderRadius:2},
  ]},options:CD};}
  else{cfg={type:"bar",data:{labels,datasets:[
    {label:"æˆäº¤é‡",data:disp.map(d=>d.v),backgroundColor:"rgba(61,158,255,.4)",borderRadius:2},
  ]},options:{...CD,scales:{...CD.scales,y:{...CD.scales.y,ticks:{...CD.scales.y.ticks,callback:v=>`${(v/1e6).toFixed(0)}M`}}}}};}
  ch["cv-main"]=new Chart(document.getElementById("cv-main"),cfg);
}

// FINANCIALS
function renderFI(){
  const s=DB[cur];
  document.getElementById("content").innerHTML=`
    <div class="grid2" style="margin-bottom:10px">
      <div class="card"><div class="card-title">ğŸ“‹ å­£åº¦è´¢æŠ¥</div>
        <table class="dt"><thead><tr><th style="text-align:left">å­£åº¦</th><th>è¥æ”¶(äº¿)</th><th>å‡€åˆ©æ¶¦</th><th>EPS</th></tr></thead>
        <tbody>${QTR.map(q=>`<tr><td>${q.q}</td><td style="color:var(--text1)">${q.rv}</td><td style="color:${q.ni>250?'var(--green)':'var(--text1)'}">${q.ni}</td><td style="color:var(--blue)">$${q.eps}</td></tr>`).join("")}</tbody></table>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="card"><div class="card-title">ğŸ’° ç›ˆåˆ©èƒ½åŠ›</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
            ${mcard("æ¯›åˆ©ç‡",s.gm,"")}${mcard("å‡€åˆ©ç‡",s.nm,"")}${mcard("ROE",s.roe,"",true)}${mcard("ROA",s.ra,"")}
          </div>
        </div>
        <div class="card"><div class="card-title">ğŸ¦ èµ„äº§è´Ÿå€º</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
            ${mcard("è´Ÿå€ºç‡",s.dr,"")}${mcard("æµåŠ¨æ¯”ç‡",s.cr,"")}${mcard("è‚¡æ¯ç‡",s.dy,"")}${mcard("Beta",s.b,"")}
          </div>
        </div>
      </div>
    </div>
    <div class="card-green"><div class="card-title" style="color:var(--green)">ğŸ“ ç»¼åˆè§£è¯»</div>
      <div style="font-size:12px;color:var(--text2);line-height:1.8">
        <strong style="color:var(--text1)">${s.n}</strong> è¿‘ä¸¤å­£è¥æ”¶æŒç»­å¢é•¿ï¼ŒQ2'24 åŒæ¯” +23%ã€‚
        æ¯›åˆ©ç‡ ${s.gm}ï¼Œå‡€åˆ©ç‡ ${s.nm}ï¼Œç›ˆåˆ©è´¨é‡${parseFloat(s.nm)>20?'<span style="color:var(--green)">ä¼˜ç§€</span>':'ç¨³å®š'}ã€‚
        ROE ${s.roe} èµ„æœ¬æ•ˆç‡${parseFloat(s.roe)>30?'<span style="color:var(--green)">æå¼º</span>':'è‰¯å¥½'}ï¼Œ
        è´Ÿå€ºç‡ ${s.dr} è´¢åŠ¡${parseFloat(s.dr)<20?'<span style="color:var(--green)">éå¸¸å¥åº·</span>':'ç¨³å¥'}ã€‚
        <br><span style="font-size:10px;color:var(--text3);margin-top:4px;display:block">âš ï¸ æ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ä¾›æ¼”ç¤ºï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</span>
      </div>
    </div>`;
}

// COMPARE
function addToCompare(){
  if(!cmpList.includes(cur)){
    if(cmpList.length>=4){showToast("æœ€å¤šå¯¹æ¯”4åª","warn");return;}
    cmpList.push(cur); showToast(`å·²æ·»åŠ  ${cur} åˆ°å¯¹æ¯”`,"success");
  }
  switchTab("cp",document.querySelector(".tab-bar .tab:nth-child(4)"));
}
function renderCP(){
  if(!cmpList.length){document.getElementById("content").innerHTML='<div class="empty">ç‚¹å‡»é¡¶éƒ¨ âš–ï¸ å¯¹æ¯” æŒ‰é’®<br>å°†è‚¡ç¥¨åŠ å…¥å¯¹æ¯”åˆ—è¡¨<br><br><span style="font-size:10px">æœ€å¤šåŒæ—¶å¯¹æ¯” 4 åªè‚¡ç¥¨</span></div>';return;}
  const colors=["#00e87a","#3d9eff","#f5a623","#a855f7"];
  const chips=cmpList.map(t=>`<span class="chip">${t} ${DB[t]?.n}<span class="cdel" onclick="cmpList=cmpList.filter(x=>x!=='${t}');renderCP()">Ã—</span></span>`).join("");
  const mKeys=["pe","pb","roe","eps","b","gm","nm","dr","dy"];
  const mLabels={pe:"P/E",pb:"P/B",roe:"ROE",eps:"EPS",b:"Beta",gm:"æ¯›åˆ©ç‡",nm:"å‡€åˆ©ç‡",dr:"è´Ÿå€ºç‡",dy:"è‚¡æ¯ç‡"};
  const rows=mKeys.map(k=>`<tr><td>${mLabels[k]}</td>${cmpList.map(t=>`<td style="text-align:center;color:var(--text1);font-family:monospace">${DB[t]?.[k]||"â€”"}</td>`).join("")}</tr>`).join("");
  const heads=cmpList.map((t,i)=>`<th style="text-align:center;color:${colors[i]}">${t}<br><span style="font-weight:400;color:var(--text3);font-size:9px">${DB[t]?.n}</span></th>`).join("");
  document.getElementById("content").innerHTML=`
    <div style="background:rgba(61,158,255,.06);border:1px solid rgba(61,158,255,.15);border-radius:8px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;font-size:11px;font-family:monospace;color:var(--blue)">
      <span>âš–ï¸ å¯¹æ¯”æ¨¡å¼</span>
      <div>${chips}</div>
      <button onclick="cmpList=[];renderCP()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:11px;font-family:monospace">æ¸…ç©º</button>
    </div>
    <div class="card" style="margin-bottom:10px"><div class="card-title">ä»·æ ¼èµ°åŠ¿å¯¹æ¯”ï¼ˆè¿‘60æ—¥ï¼Œå½’ä¸€åŒ– %ï¼‰</div><div class="chart-box tall"><canvas id="cv-cmp"></canvas></div></div>
    <div class="card"><div class="card-title">å…³é”®æŒ‡æ ‡å¯¹æ¯”</div>
      <table class="dt"><thead><tr><th>æŒ‡æ ‡</th>${heads}</tr></thead><tbody>${rows}</tbody></table>
    </div>`;
  setTimeout(()=>{
    dc("cv-cmp");
    const datasets=cmpList.map((t,i)=>{const d=getPD(t).slice(-60),base=d[0].c;return{label:t,data:d.map(x=>+((x.c/base-1)*100).toFixed(2)),borderColor:colors[i],backgroundColor:colors[i]+"18",borderWidth:2,pointRadius:0,fill:false,tension:.3};});
    const labels=getPD(cmpList[0]).slice(-60).map(d=>d.dt);
    ch["cv-cmp"]=new Chart(document.getElementById("cv-cmp"),{type:"line",data:{labels,datasets},
      options:{...CD,plugins:{...CD.plugins,legend:{display:true,labels:{color:"#9090a8",font:{family:"monospace",size:10},boxWidth:12}}},
        scales:{...CD.scales,y:{...CD.scales.y,ticks:{...CD.scales.y.ticks,callback:v=>`${v>0?'+':''}${v}%`}}}}});
  },50);
}

// WATCHLIST
function toggleWL(){toggleWLfor(cur);load(cur);}
function toggleWLfor(t){
  if(WL.includes(t)){WL=WL.filter(x=>x!==t);showToast(`ç§»å‡ºè‡ªé€‰ï¼š${t}`);}
  else{WL.push(t);showToast(`â­ åŠ å…¥è‡ªé€‰ï¼š${t}`,"success");}
  saveWL(); renderSB();
  const inWL=WL.includes(cur);
  document.getElementById("bstar").textContent=inWL?"â˜… å·²è‡ªé€‰":"â˜† è‡ªé€‰";
  document.getElementById("bstar").className=`abtn${inWL?" star-on":""}`;
}

// ALERTS
function openAlert(){
  const s=DB[cur],q=quote(cur);
  document.getElementById("amod-t").textContent=`ğŸ”” ${s.n}ï¼ˆ${cur}ï¼‰æé†’`;
  document.getElementById("amod-s").textContent=`å½“å‰ä»·æ ¼ï¼š${q.price.toFixed(2)}`;
  renderAL(); document.getElementById("amodal").classList.remove("hidden");
}
function closeAlert(){document.getElementById("amodal").classList.add("hidden");}
function renderAL(){
  const list=AL[cur]||[];
  const tl={above:"é«˜äº",below:"ä½äº",up_pct:"æ¶¨å¹…è¶…",dn_pct:"è·Œå¹…è¶…"};
  document.getElementById("alist").innerHTML=list.length?
    list.map((a,i)=>`<div class="aitem"><span style="color:var(--text2)">${tl[a.type]}</span><span style="color:var(--blue);font-weight:600">${a.val}${a.type.includes('pct')?'%':''}</span><button class="adel" onclick="delAL(${i})">Ã—</button></div>`).join(""):
    '<div style="font-size:10px;color:var(--text3);font-family:monospace;padding:6px 0">æš‚æ— æé†’</div>';
}
function addAlert(){
  const type=document.getElementById("atype").value,val=parseFloat(document.getElementById("aval").value);
  if(!val||isNaN(val)){showToast("è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼","warn");return;}
  if(!AL[cur])AL[cur]=[];
  AL[cur].push({type,val,triggered:false}); saveAL();
  document.getElementById("aval").value=""; renderAL();
  showToast("âœ… æé†’å·²è®¾ç½®","success");
  document.getElementById("balert").className="abtn alert-on"; renderSB();
}
function delAL(i){
  AL[cur].splice(i,1); if(!AL[cur].length)delete AL[cur]; saveAL(); renderAL();
  document.getElementById("balert").className=`abtn${AL[cur]&&AL[cur].length?" alert-on":""}`;
  renderSB();
}
function checkAL(t,price){
  const list=AL[t]; if(!list||!list.length) return;
  const q=quote(t);
  list.forEach(a=>{
    if(a.triggered) return;
    const hit=(a.type==="above"&&price>=a.val)||(a.type==="below"&&price<=a.val)||(a.type==="up_pct"&&parseFloat(q.pct)>=a.val)||(a.type==="dn_pct"&&parseFloat(q.pct)<=-a.val);
    if(hit){a.triggered=true;saveAL();showToast(`ğŸ”” ${DB[t].n} è§¦å‘æé†’ï¼ç°ä»· ${price.toFixed(2)}`,"warn");
      if("Notification"in window&&Notification.permission==="granted")new Notification(`ğŸ“ˆ StockAIï¼š${DB[t].n}`,{body:`å½“å‰ä»· ${price.toFixed(2)} å·²è§¦å‘æé†’`});}
  });
}

// TOAST
let tt;
function showToast(msg,type=""){
  const el=document.getElementById("toast");el.textContent=msg;el.className=`toast show ${type}`;
  clearTimeout(tt);tt=setTimeout(()=>el.className="toast",2800);
}

// KEYBOARD
document.addEventListener("keydown",e=>{
  if(e.key==="/"&&document.activeElement.tagName!=="INPUT"){e.preventDefault();document.getElementById("sinput").focus();}
  if(e.key==="Escape")closeAlert();
});
if("Notification"in window&&Notification.permission==="default")setTimeout(()=>Notification.requestPermission(),2000);

// INIT
renderSB(); load("AAPL");
</script>
</body>
</html>
